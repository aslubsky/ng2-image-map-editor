import { Area } from './area.class';
import { Helper } from './helper.class';
import { Utils } from './utils.class';
/**
 * The constructor for polygons
 *
 * Initial state:
 *    (x, y)
 * only one point of the line
 *
 * @constructor
 * @param coords {Object} - coordinates of the begin pointer, e.g. {x: 100, y: 200}
 */
export class Polygon extends Area {
    constructor(coords, type) {
        super(coords, 'polygon');
        /**
         * @namespace
         * @property {array} points - Array of coordinates of polygon points
         */
        this._params = {
            points: [coords.x, coords.y]
        };
        this._el = document.createElementNS(Area.SVG_NS, 'polyline');
        this._groupEl.appendChild(this._el);
        this._helpers = [
            new Helper(this._groupEl, this._params.points[0], this._params.points[1], 'number'),
            (new Helper(this._groupEl, this._params.points[0], this._params.points[1], 'pointMove')).setId(1)
        ];
        this._helpers[0].setNumber(coords.n);
        this.selected_point = -1;
        this.select().redraw();
        Area.app.addObject(this); //add this object to array of all objects
    }
    setCoords(params) {
        var coords_values = params.points.join(' ');
        this._el.setAttribute('points', coords_values);
        Utils.foreach(this._helpers, function (x, i) {
            if (x._el.action == 'number') {
                x.setCoords(params.points[0], params.points[1]);
            }
            else {
                i = i - 1;
                x.setCoords(params.points[2 * i], params.points[2 * i + 1]);
            }
            //x.setCoords(params.points[2 * i], params.points[2 * i + 1]);
        });
        return this;
    }
    setSVGAttributes(params) {
        var coords_values = params.points.join(' ');
        this._el.setAttribute('points', coords_values);
        Utils.foreach(this._helpers, function (helper, i) {
            if (helper._el.action == 'number') {
                helper.setCoords(params.points[0], params.points[1]);
            }
            else {
                i = i - 1;
                helper.setCoords(params.points[2 * i], params.points[2 * i + 1]);
            }
        });
        return this;
    }
    setParams(arr) {
        if (arr.isArray) {
            this._params.points = Array.prototype.slice.call(arr);
        }
        else {
            this._params.points = Array.prototype.slice.call(arr.points);
        }
        return this;
    }
    addPoint(x, y) {
        var helper = new Helper(this._groupEl, x, y, 'pointMove');
        helper.setId(this._helpers.length);
        this._helpers.push(helper);
        this._params.points.push(x, y);
        this.redraw();
        return this;
    }
    right_angle(x, y) {
        var old_x = this._params.points[this._params.points.length - 2], old_y = this._params.points[this._params.points.length - 1], dx = x - old_x, dy = -(y - old_y), tan = dy / dx; //tangens
        if (dx > 0 && dy > 0) {
            if (tan > 2.414) {
                x = old_x;
            }
            else if (tan < 0.414) {
                y = old_y;
            }
            else {
                Math.abs(dx) > Math.abs(dy) ? x = old_x + dy : y = old_y - dx;
            }
        }
        else if (dx < 0 && dy > 0) {
            if (tan < -2.414) {
                x = old_x;
            }
            else if (tan > -0.414) {
                y = old_y;
            }
            else {
                Math.abs(dx) > Math.abs(dy) ? x = old_x - dy : y = old_y + dx;
            }
        }
        else if (dx < 0 && dy < 0) {
            if (tan > 2.414) {
                x = old_x;
            }
            else if (tan < 0.414) {
                y = old_y;
            }
            else {
                Math.abs(dx) > Math.abs(dy) ? x = old_x + dy : y = old_y - dx;
            }
        }
        else if (dx > 0 && dy < 0) {
            if (tan < -2.414) {
                x = old_x;
            }
            else if (tan > -0.414) {
                y = old_y;
            }
            else {
                Math.abs(dx) > Math.abs(dy) ? x = old_x - dy : y = old_y + dx;
            }
        }
        return {
            x: x,
            y: y
        };
    }
    dynamicDraw(x, y, right_angle) {
        var temp_params = {
            points: [].concat(this._params.points)
        };
        if (right_angle) {
            var right_coords = this.right_angle(x, y);
            x = right_coords.x;
            y = right_coords.y;
        }
        temp_params.points.push(x, y);
        this.redraw(temp_params);
        return temp_params;
    }
    onProcessDrawing(e) {
        var coords = Utils.getRightCoords(e.pageX, e.pageY);
        this.dynamicDraw(coords.x, coords.y, e.shiftKey);
    }
    onAddPointDrawing(e) {
        var coords = Utils.getRightCoords(e.pageX, e.pageY);
        if (e.shiftKey) {
            coords = this.right_angle(coords.x, coords.y);
        }
        this.addPoint(coords.x, coords.y);
    }
    onStopDrawing(e) {
        if (e.type == 'click' || (e.type == 'keydown' && e.keyCode == 13)) {
            if (this._params.points.length >= 6) { //>= 3 points for polygon
                this._polyline = this._el;
                this._el = document.createElementNS(Area.SVG_NS, 'polygon');
                this._groupEl.replaceChild(this._el, this._polyline);
                this.redraw(this._params).deselect();
                delete (this._polyline);
                Area.app.removeAllEvents()
                    .setIsDraw(false)
                    .resetNewArea();
            }
        }
        e.stopPropagation();
    }
    redraw(params) {
        this.setSVGAttributes(params ? params : this._params);
        return this;
    }
    move(x, y) {
        //var temp_params = Object.create(this._params);
        var temp_params = this._params;
        for (var i = 0, count = this._params.points.length; i < count; i++) {
            this._params.points[i] += (i % 2 ? y : x);
        }
        return temp_params;
    }
    pointMove(x, y) {
        if (this.selected_point == 1) {
            this._params.points[0] += x;
            this._params.points[1] += y;
        }
        else {
            this._params.points[2 * this.selected_point - 2] += x;
            this._params.points[2 * this.selected_point - 1] += y;
        }
        return this._params;
    }
    dynamicEdit(temp_params) {
        this.setCoords(temp_params);
        return temp_params;
    }
    onProcessEditing(e) {
        var editType = Area.app.getEditType();
        if (typeof this[editType] === 'function') {
            this.dynamicEdit(this[editType](e.pageX - this.delta.x, e.pageY - this.delta.y));
            this.delta.x = e.pageX;
            this.delta.y = e.pageY;
        }
    }
    onStopEditing(e) {
        var editType = Area.app.getEditType();
        this.setParams(this.dynamicEdit(this[editType](e.pageX - this.delta.x, e.pageY - this.delta.y)));
        Area.app.removeAllEvents();
    }
    toString() {
        for (var i = 0, count = this._params.points.length, str = ''; i < count; i++) {
            str += this._params.points[i];
            if (i != count - 1) {
                str += ', ';
            }
        }
        return '<area shape="poly" coords="'
            + str
            + '"'
            + (this.href ? ' href="' + this.href + '"' : '')
            + (this.alt ? ' alt="' + this.alt + '"' : '')
            + (this.title ? ' title="' + this.title + '"' : '')
            + ' />';
    }
    /**
     * Returns true if coords array is valid for polygons and false otherwise
     *
     * @static
     * @param coords {Array} - coords for new polygon as array
     * @return {boolean}
     */
    static testCoords(coords) {
        return coords.length >= 6 && coords.length % 2 === 0;
    }
    static createFromSaved(params) {
        if (!this.testCoords(params.coords)) {
            return;
        }
        Area.app.setIsDraw(true);
        var area = new Polygon({
            x: params.coords[0],
            y: params.coords[1],
            n: params.number
        });
        for (var i = 2, c = params.coords.length; i < c; i += 2) {
            area.addPoint(params.coords[i], params.coords[i + 1]);
        }
        area._polyline = area._el;
        area._el = document.createElementNS(Area.SVG_NS, 'polygon');
        area._groupEl.replaceChild(area._el, area._polyline);
        area.setCoords(area._params).deselect();
        delete (area._polyline);
        Area.app.setIsDraw(false)
            .resetNewArea();
        area.setInfoAttributes(params);
    }
    /**
     * Creates new polygon and add drawing handlers for DOM-elements
     *
     * @param coords {Object} coords
     * @returns created polygon
     */
    static createAndStartDrawing(coords) {
        coords.n = Area.app.getAreas().length;
        var newArea = new Polygon(coords);
        Area.app.addEvent(Area.app.domElements.container, 'mousemove', newArea.onProcessDrawing.bind(newArea))
            .addEvent(Area.app.domElements.container, 'click', newArea.onAddPointDrawing.bind(newArea))
            .addEvent(document, 'keydown', newArea.onStopDrawing.bind(newArea))
            .addEvent(newArea._helpers[0]._el, 'click', newArea.onStopDrawing.bind(newArea));
        return newArea;
    }
    toJSON() {
        return {
            type: 'polygon',
            coords: this._params.points,
            href: this.attributes.href,
            alt: this.attributes.alt,
            title: this.attributes.title
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9seWdvbi5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wb2x5Z29uLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFDbEMsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFcEM7Ozs7Ozs7OztHQVNHO0FBQ0gsTUFBTSxPQUFPLE9BQVEsU0FBUSxJQUFJO0lBSzdCLFlBQVksTUFBVyxFQUFFLElBQVU7UUFDL0IsS0FBSyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztRQUV6Qjs7O1dBR0c7UUFDSCxJQUFJLENBQUMsT0FBTyxHQUFHO1lBQ1gsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQy9CLENBQUE7UUFFRCxJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFcEMsSUFBSSxDQUFDLFFBQVEsR0FBRztZQUNaLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDO1lBQ25GLENBQUMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFD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QUMzQixJQUFJLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJO1lBQzFCLEdBQUcsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7WUFDeEIsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSztTQUMvQixDQUFBO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBcmVhfSBmcm9tICcuL2FyZWEuY2xhc3MnO1xuaW1wb3J0IHtIZWxwZXJ9IGZyb20gJy4vaGVscGVyLmNsYXNzJztcbmltcG9ydCB7VXRpbHN9IGZyb20gJy4vdXRpbHMuY2xhc3MnO1xuXG4vKipcbiAqIFRoZSBjb25zdHJ1Y3RvciBmb3IgcG9seWdvbnNcbiAqXG4gKiBJbml0aWFsIHN0YXRlOlxuICogICAgKHgsIHkpXG4gKiBvbmx5IG9uZSBwb2ludCBvZiB0aGUgbGluZVxuICpcbiAqIEBjb25zdHJ1Y3RvclxuICogQHBhcmFtIGNvb3JkcyB7T2JqZWN0fSAtIGNvb3JkaW5hdGVzIG9mIHRoZSBiZWdpbiBwb2ludGVyLCBlLmcuIHt4OiAxMDAsIHk6IDIwMH1cbiAqL1xuZXhwb3J0IGNsYXNzIFBvbHlnb24gZXh0ZW5kcyBBcmVhIHtcblxuICAgIHByaXZhdGUgc2VsZWN0ZWRfcG9pbnQ6IG51bWJlcjtcbiAgICBwcml2YXRlIF9wb2x5bGluZTogYW55O1xuXG4gICAgY29uc3RydWN0b3IoY29vcmRzOiBhbnksIHR5cGU/OiBhbnkpIHtcbiAgICAgICAgc3VwZXIoY29vcmRzLCAncG9seWdvbicpO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAbmFtZXNwYWNlXG4gICAgICAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IHBvaW50cyAtIEFycmF5IG9mIGNvb3JkaW5hdGVzIG9mIHBvbHlnb24gcG9pbnRzXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9wYXJhbXMgPSB7XG4gICAgICAgICAgICBwb2ludHM6IFtjb29yZHMueCwgY29vcmRzLnldXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhBcmVhLlNWR19OUywgJ3BvbHlsaW5lJyk7XG4gICAgICAgIHRoaXMuX2dyb3VwRWwuYXBwZW5kQ2hpbGQodGhpcy5fZWwpO1xuXG4gICAgICAgIHRoaXMuX2hlbHBlcnMgPSBbIC8vYXJyYXkgb2YgYWxsIGhlbHBlcnMtcmVjdGFuZ2xlc1xuICAgICAgICAgICAgbmV3IEhlbHBlcih0aGlzLl9ncm91cEVsLCB0aGlzLl9wYXJhbXMucG9pbnRzWzBdLCB0aGlzLl9wYXJhbXMucG9pbnRzWzFdLCAnbnVtYmVyJyksXG4gICAgICAgICAgICAobmV3IEhlbHBlcih0aGlzLl9ncm91cEVsLCB0aGlzLl9wYXJhbXMucG9pbnRzWzBdLCB0aGlzLl9wYXJhbXMucG9pbnRzWzFdLCAncG9pbnRNb3ZlJykpLnNldElkKDEpXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuX2hlbHBlcnNbMF0uc2V0TnVtYmVyKGNvb3Jkcy5uKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZF9wb2ludCA9IC0xO1xuXG4gICAgICAgIHRoaXMuc2VsZWN0KCkucmVkcmF3KCk7XG5cbiAgICAgICAgQXJlYS5hcHAuYWRkT2JqZWN0KHRoaXMpOyAvL2FkZCB0aGlzIG9iamVjdCB0byBhcnJheSBvZiBhbGwgb2JqZWN0c1xuICAgIH1cblxuXG4gICAgcHVibGljIHNldENvb3JkcyhwYXJhbXM/OiBhbnkpIHtcbiAgICAgICAgdmFyIGNvb3Jkc192YWx1ZXMgPSBwYXJhbXMucG9pbnRzLmpvaW4oJyAnKTtcbiAgICAgICAgdGhpcy5fZWwuc2V0QXR0cmlidXRlKCdwb2ludHMnLCBjb29yZHNfdmFsdWVzKTtcbiAgICAgICAgVXRpbHMuZm9yZWFjaCh0aGlzLl9oZWxwZXJzLCBmdW5jdGlvbiAoeCwgaSkge1xuICAgICAgICAgICAgaWYgKHguX2VsLmFjdGlvbiA9PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIHguc2V0Q29vcmRzKHBhcmFtcy5wb2ludHNbMF0sIHBhcmFtcy5wb2ludHNbMV0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpID0gaSAtIDE7XG4gICAgICAgICAgICAgICAgeC5zZXRDb29yZHMocGFyYW1zLnBvaW50c1syICogaV0sIHBhcmFtcy5wb2ludHNbMiAqIGkgKyAxXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL3guc2V0Q29vcmRzKHBhcmFtcy5wb2ludHNbMiAqIGldLCBwYXJhbXMucG9pbnRzWzIgKiBpICsgMV0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U1ZHQXR0cmlidXRlcyhwYXJhbXMpIHtcbiAgICAgICAgdmFyIGNvb3Jkc192YWx1ZXMgPSBwYXJhbXMucG9pbnRzLmpvaW4oJyAnKTtcbiAgICAgICAgdGhpcy5fZWwuc2V0QXR0cmlidXRlKCdwb2ludHMnLCBjb29yZHNfdmFsdWVzKTtcblxuICAgICAgICBVdGlscy5mb3JlYWNoKHRoaXMuX2hlbHBlcnMsIGZ1bmN0aW9uIChoZWxwZXIsIGkpIHtcbiAgICAgICAgICAgIGlmIChoZWxwZXIuX2VsLmFjdGlvbiA9PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIGhlbHBlci5zZXRDb29yZHMocGFyYW1zLnBvaW50c1swXSwgcGFyYW1zLnBvaW50c1sxXSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGkgPSBpIC0gMTtcbiAgICAgICAgICAgICAgICBoZWxwZXIuc2V0Q29vcmRzKHBhcmFtcy5wb2ludHNbMiAqIGldLCBwYXJhbXMucG9pbnRzWzIgKiBpICsgMV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFBhcmFtcyhhcnIpIHtcbiAgICAgICAgaWYgKGFyci5pc0FycmF5KSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucG9pbnRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5wb2ludHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcnIucG9pbnRzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkUG9pbnQoeCwgeSkge1xuICAgICAgICB2YXIgaGVscGVyID0gbmV3IEhlbHBlcih0aGlzLl9ncm91cEVsLCB4LCB5LCAncG9pbnRNb3ZlJyk7XG4gICAgICAgIGhlbHBlci5zZXRJZCh0aGlzLl9oZWxwZXJzLmxlbmd0aCk7XG4gICAgICAgIHRoaXMuX2hlbHBlcnMucHVzaChoZWxwZXIpO1xuICAgICAgICB0aGlzLl9wYXJhbXMucG9pbnRzLnB1c2goeCwgeSk7XG4gICAgICAgIHRoaXMucmVkcmF3KCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIHJpZ2h0X2FuZ2xlKHgsIHkpIHtcbiAgICAgICAgdmFyIG9sZF94ID0gdGhpcy5fcGFyYW1zLnBvaW50c1t0aGlzLl9wYXJhbXMucG9pbnRzLmxlbmd0aCAtIDJdLFxuICAgICAgICAgICAgb2xkX3kgPSB0aGlzLl9wYXJhbXMucG9pbnRzW3RoaXMuX3BhcmFtcy5wb2ludHMubGVuZ3RoIC0gMV0sXG4gICAgICAgICAgICBkeCA9IHggLSBvbGRfeCxcbiAgICAgICAgICAgIGR5ID0gLSh5IC0gb2xkX3kpLFxuICAgICAgICAgICAgdGFuID0gZHkgLyBkeDsgLy90YW5nZW5zXG5cbiAgICAgICAgaWYgKGR4ID4gMCAmJiBkeSA+IDApIHtcbiAgICAgICAgICAgIGlmICh0YW4gPiAyLjQxNCkge1xuICAgICAgICAgICAgICAgIHggPSBvbGRfeDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFuIDwgMC40MTQpIHtcbiAgICAgICAgICAgICAgICB5ID0gb2xkX3k7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIE1hdGguYWJzKGR4KSA+IE1hdGguYWJzKGR5KSA/IHggPSBvbGRfeCArIGR5IDogeSA9IG9sZF95IC0gZHg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZHggPCAwICYmIGR5ID4gMCkge1xuICAgICAgICAgICAgaWYgKHRhbiA8IC0yLjQxNCkge1xuICAgICAgICAgICAgICAgIHggPSBvbGRfeDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFuID4gLTAuNDE0KSB7XG4gICAgICAgICAgICAgICAgeSA9IG9sZF95O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBNYXRoLmFicyhkeCkgPiBNYXRoLmFicyhkeSkgPyB4ID0gb2xkX3ggLSBkeSA6IHkgPSBvbGRfeSArIGR4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGR4IDwgMCAmJiBkeSA8IDApIHtcbiAgICAgICAgICAgIGlmICh0YW4gPiAyLjQxNCkge1xuICAgICAgICAgICAgICAgIHggPSBvbGRfeDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFuIDwgMC40MTQpIHtcbiAgICAgICAgICAgICAgICB5ID0gb2xkX3k7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIE1hdGguYWJzKGR4KSA+IE1hdGguYWJzKGR5KSA/IHggPSBvbGRfeCArIGR5IDogeSA9IG9sZF95IC0gZHg7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZHggPiAwICYmIGR5IDwgMCkge1xuICAgICAgICAgICAgaWYgKHRhbiA8IC0yLjQxNCkge1xuICAgICAgICAgICAgICAgIHggPSBvbGRfeDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFuID4gLTAuNDE0KSB7XG4gICAgICAgICAgICAgICAgeSA9IG9sZF95O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBNYXRoLmFicyhkeCkgPiBNYXRoLmFicyhkeSkgPyB4ID0gb2xkX3ggLSBkeSA6IHkgPSBvbGRfeSArIGR4O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHg6IHgsXG4gICAgICAgICAgICB5OiB5XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZHluYW1pY0RyYXcoeCwgeSwgcmlnaHRfYW5nbGUpIHtcbiAgICAgICAgdmFyIHRlbXBfcGFyYW1zID0ge1xuICAgICAgICAgICAgcG9pbnRzOiBbXS5jb25jYXQodGhpcy5fcGFyYW1zLnBvaW50cylcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyaWdodF9hbmdsZSkge1xuICAgICAgICAgICAgdmFyIHJpZ2h0X2Nvb3JkcyA9IHRoaXMucmlnaHRfYW5nbGUoeCwgeSk7XG4gICAgICAgICAgICB4ID0gcmlnaHRfY29vcmRzLng7XG4gICAgICAgICAgICB5ID0gcmlnaHRfY29vcmRzLnk7XG4gICAgICAgIH1cblxuICAgICAgICB0ZW1wX3BhcmFtcy5wb2ludHMucHVzaCh4LCB5KTtcblxuICAgICAgICB0aGlzLnJlZHJhdyh0ZW1wX3BhcmFtcyk7XG5cbiAgICAgICAgcmV0dXJuIHRlbXBfcGFyYW1zO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblByb2Nlc3NEcmF3aW5nKGUpIHtcbiAgICAgICAgdmFyIGNvb3JkcyA9IFV0aWxzLmdldFJpZ2h0Q29vcmRzKGUucGFnZVgsIGUucGFnZVkpO1xuXG4gICAgICAgIHRoaXMuZHluYW1pY0RyYXcoY29vcmRzLngsIGNvb3Jkcy55LCBlLnNoaWZ0S2V5KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25BZGRQb2ludERyYXdpbmcoZSkge1xuICAgICAgICB2YXIgY29vcmRzID0gVXRpbHMuZ2V0UmlnaHRDb29yZHMoZS5wYWdlWCwgZS5wYWdlWSk7XG5cbiAgICAgICAgaWYgKGUuc2hpZnRLZXkpIHtcbiAgICAgICAgICAgIGNvb3JkcyA9IHRoaXMucmlnaHRfYW5nbGUoY29vcmRzLngsIGNvb3Jkcy55KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYWRkUG9pbnQoY29vcmRzLngsIGNvb3Jkcy55KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25TdG9wRHJhd2luZyhlKSB7XG4gICAgICAgIGlmIChlLnR5cGUgPT0gJ2NsaWNrJyB8fCAoZS50eXBlID09ICdrZXlkb3duJyAmJiBlLmtleUNvZGUgPT0gMTMpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5fcGFyYW1zLnBvaW50cy5sZW5ndGggPj0gNikgey8vPj0gMyBwb2ludHMgZm9yIHBvbHlnb25cbiAgICAgICAgICAgICAgICB0aGlzLl9wb2x5bGluZSA9IHRoaXMuX2VsO1xuICAgICAgICAgICAgICAgIHRoaXMuX2VsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKEFyZWEuU1ZHX05TLCAncG9seWdvbicpO1xuICAgICAgICAgICAgICAgIHRoaXMuX2dyb3VwRWwucmVwbGFjZUNoaWxkKHRoaXMuX2VsLCB0aGlzLl9wb2x5bGluZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWRyYXcodGhpcy5fcGFyYW1zKS5kZXNlbGVjdCgpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSh0aGlzLl9wb2x5bGluZSk7XG5cbiAgICAgICAgICAgICAgICBBcmVhLmFwcC5yZW1vdmVBbGxFdmVudHMoKVxuICAgICAgICAgICAgICAgICAgICAuc2V0SXNEcmF3KGZhbHNlKVxuICAgICAgICAgICAgICAgICAgICAucmVzZXROZXdBcmVhKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVkcmF3KHBhcmFtcz86IGFueSkge1xuICAgICAgICB0aGlzLnNldFNWR0F0dHJpYnV0ZXMocGFyYW1zID8gcGFyYW1zIDogdGhpcy5fcGFyYW1zKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHVibGljIG1vdmUoeCwgeSkgeyAvL29mZnNldCB4IGFuZCB5XG4gICAgICAgIC8vdmFyIHRlbXBfcGFyYW1zID0gT2JqZWN0LmNyZWF0ZSh0aGlzLl9wYXJhbXMpO1xuICAgICAgICB2YXIgdGVtcF9wYXJhbXMgPSB0aGlzLl9wYXJhbXM7XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNvdW50ID0gdGhpcy5fcGFyYW1zLnBvaW50cy5sZW5ndGg7IGkgPCBjb3VudDsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucG9pbnRzW2ldICs9IChpICUgMiA/IHkgOiB4KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGVtcF9wYXJhbXM7XG4gICAgfVxuXG4gICAgcHVibGljIHBvaW50TW92ZSh4LCB5KSB7Ly9vZmZzZXQgeCBhbmQgeVxuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZF9wb2ludCA9PSAxKSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucG9pbnRzWzBdICs9IHg7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucG9pbnRzWzFdICs9IHk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9wYXJhbXMucG9pbnRzWzIgKiB0aGlzLnNlbGVjdGVkX3BvaW50IC0gMl0gKz0geDtcbiAgICAgICAgICAgIHRoaXMuX3BhcmFtcy5wb2ludHNbMiAqIHRoaXMuc2VsZWN0ZWRfcG9pbnQgLSAxXSArPSB5O1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX3BhcmFtcztcbiAgICB9XG5cbiAgICBwdWJsaWMgZHluYW1pY0VkaXQodGVtcF9wYXJhbXMpIHtcbiAgICAgICAgdGhpcy5zZXRDb29yZHModGVtcF9wYXJhbXMpO1xuXG4gICAgICAgIHJldHVybiB0ZW1wX3BhcmFtcztcbiAgICB9XG5cbiAgICBwdWJsaWMgb25Qcm9jZXNzRWRpdGluZyhlKSB7XG4gICAgICAgIHZhciBlZGl0VHlwZSA9IEFyZWEuYXBwLmdldEVkaXRUeXBlKCk7XG4gICAgICAgIGlmICh0eXBlb2YgdGhpc1tlZGl0VHlwZV0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHRoaXMuZHluYW1pY0VkaXQoXG4gICAgICAgICAgICAgICAgdGhpc1tlZGl0VHlwZV0oZS5wYWdlWCAtIHRoaXMuZGVsdGEueCwgZS5wYWdlWSAtIHRoaXMuZGVsdGEueSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLmRlbHRhLnggPSBlLnBhZ2VYO1xuICAgICAgICAgICAgdGhpcy5kZWx0YS55ID0gZS5wYWdlWTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBvblN0b3BFZGl0aW5nKGUpIHtcbiAgICAgICAgdmFyIGVkaXRUeXBlID0gQXJlYS5hcHAuZ2V0RWRpdFR5cGUoKTtcbiAgICAgICAgdGhpcy5zZXRQYXJhbXMoXG4gICAgICAgICAgICB0aGlzLmR5bmFtaWNFZGl0KFxuICAgICAgICAgICAgICAgIHRoaXNbZWRpdFR5cGVdKGUucGFnZVggLSB0aGlzLmRlbHRhLngsIGUucGFnZVkgLSB0aGlzLmRlbHRhLnkpXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICAgIEFyZWEuYXBwLnJlbW92ZUFsbEV2ZW50cygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b1N0cmluZygpIHsgLy90byBodG1sIG1hcCBhcmVhIGNvZGVcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNvdW50ID0gdGhpcy5fcGFyYW1zLnBvaW50cy5sZW5ndGgsIHN0ciA9ICcnOyBpIDwgY291bnQ7IGkrKykge1xuICAgICAgICAgICAgc3RyICs9IHRoaXMuX3BhcmFtcy5wb2ludHNbaV07XG4gICAgICAgICAgICBpZiAoaSAhPSBjb3VudCAtIDEpIHtcbiAgICAgICAgICAgICAgICBzdHIgKz0gJywgJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAnPGFyZWEgc2hhcGU9XCJwb2x5XCIgY29vcmRzPVwiJ1xuICAgICAgICAgICAgKyBzdHJcbiAgICAgICAgICAgICsgJ1wiJ1xuICAgICAgICAgICAgKyAodGhpcy5ocmVmID8gJyBocmVmPVwiJyArIHRoaXMuaHJlZiArICdcIicgOiAnJylcbiAgICAgICAgICAgICsgKHRoaXMuYWx0ID8gJyBhbHQ9XCInICsgdGhpcy5hbHQgKyAnXCInIDogJycpXG4gICAgICAgICAgICArICh0aGlzLnRpdGxlID8gJyB0aXRsZT1cIicgKyB0aGlzLnRpdGxlICsgJ1wiJyA6ICcnKVxuICAgICAgICAgICAgKyAnIC8+JztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIHRydWUgaWYgY29vcmRzIGFycmF5IGlzIHZhbGlkIGZvciBwb2x5Z29ucyBhbmQgZmFsc2Ugb3RoZXJ3aXNlXG4gICAgICpcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHBhcmFtIGNvb3JkcyB7QXJyYXl9IC0gY29vcmRzIGZvciBuZXcgcG9seWdvbiBhcyBhcnJheVxuICAgICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyB0ZXN0Q29vcmRzKGNvb3Jkcykge1xuICAgICAgICByZXR1cm4gY29vcmRzLmxlbmd0aCA+PSA2ICYmIGNvb3Jkcy5sZW5ndGggJSAyID09PSAwO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlRnJvbVNhdmVkKHBhcmFtcykge1xuICAgICAgICBpZiAoIXRoaXMudGVzdENvb3JkcyhwYXJhbXMuY29vcmRzKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgQXJlYS5hcHAuc2V0SXNEcmF3KHRydWUpO1xuXG4gICAgICAgIHZhciBhcmVhID0gbmV3IFBvbHlnb24oe1xuICAgICAgICAgICAgeDogcGFyYW1zLmNvb3Jkc1swXSxcbiAgICAgICAgICAgIHk6IHBhcmFtcy5jb29yZHNbMV0sXG4gICAgICAgICAgICBuOiBwYXJhbXMubnVtYmVyXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAyLCBjID0gcGFyYW1zLmNvb3Jkcy5sZW5ndGg7IGkgPCBjOyBpICs9IDIpIHtcbiAgICAgICAgICAgIGFyZWEuYWRkUG9pbnQocGFyYW1zLmNvb3Jkc1tpXSwgcGFyYW1zLmNvb3Jkc1tpICsgMV0pO1xuICAgICAgICB9XG5cbiAgICAgICAgYXJlYS5fcG9seWxpbmUgPSBhcmVhLl9lbDtcbiAgICAgICAgYXJlYS5fZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoQXJlYS5TVkdfTlMsICdwb2x5Z29uJyk7XG4gICAgICAgIGFyZWEuX2dyb3VwRWwucmVwbGFjZUNoaWxkKGFyZWEuX2VsLCBhcmVhLl9wb2x5bGluZSk7XG5cbiAgICAgICAgYXJlYS5zZXRDb29yZHMoYXJlYS5fcGFyYW1zKS5kZXNlbGVjdCgpO1xuICAgICAgICBkZWxldGUoYXJlYS5fcG9seWxpbmUpO1xuXG4gICAgICAgIEFyZWEuYXBwLnNldElzRHJhdyhmYWxzZSlcbiAgICAgICAgICAgIC5yZXNldE5ld0FyZWEoKTtcblxuICAgICAgICBhcmVhLnNldEluZm9BdHRyaWJ1dGVzKHBhcmFtcyk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIG5ldyBwb2x5Z29uIGFuZCBhZGQgZHJhd2luZyBoYW5kbGVycyBmb3IgRE9NLWVsZW1lbnRzXG4gICAgICpcbiAgICAgKiBAcGFyYW0gY29vcmRzIHtPYmplY3R9IGNvb3Jkc1xuICAgICAqIEByZXR1cm5zIGNyZWF0ZWQgcG9seWdvblxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlQW5kU3RhcnREcmF3aW5nKGNvb3Jkcykge1xuICAgICAgICBjb29yZHMubiA9IEFyZWEuYXBwLmdldEFyZWFzKCkubGVuZ3RoO1xuICAgICAgICB2YXIgbmV3QXJlYSA9IG5ldyBQb2x5Z29uKGNvb3Jkcyk7XG5cbiAgICAgICAgQXJlYS5hcHAuYWRkRXZlbnQoQXJlYS5hcHAuZG9tRWxlbWVudHMuY29udGFpbmVyLCAnbW91c2Vtb3ZlJywgbmV3QXJlYS5vblByb2Nlc3NEcmF3aW5nLmJpbmQobmV3QXJlYSkpXG4gICAgICAgICAgICAuYWRkRXZlbnQoQXJlYS5hcHAuZG9tRWxlbWVudHMuY29udGFpbmVyLCAnY2xpY2snLCBuZXdBcmVhLm9uQWRkUG9pbnREcmF3aW5nLmJpbmQobmV3QXJlYSkpXG4gICAgICAgICAgICAuYWRkRXZlbnQoZG9jdW1lbnQsICdrZXlkb3duJywgbmV3QXJlYS5vblN0b3BEcmF3aW5nLmJpbmQobmV3QXJlYSkpXG4gICAgICAgICAgICAuYWRkRXZlbnQobmV3QXJlYS5faGVscGVyc1swXS5fZWwsICdjbGljaycsIG5ld0FyZWEub25TdG9wRHJhd2luZy5iaW5kKG5ld0FyZWEpKTtcblxuICAgICAgICByZXR1cm4gbmV3QXJlYTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9KU09OKCk6IGFueSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiAncG9seWdvbicsXG4gICAgICAgICAgICBjb29yZHM6IHRoaXMuX3BhcmFtcy5wb2ludHMsXG4gICAgICAgICAgICBocmVmOiB0aGlzLmF0dHJpYnV0ZXMuaHJlZixcbiAgICAgICAgICAgIGFsdDogdGhpcy5hdHRyaWJ1dGVzLmFsdCxcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmF0dHJpYnV0ZXMudGl0bGVcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=