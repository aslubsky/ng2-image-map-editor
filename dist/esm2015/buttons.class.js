import { Utils } from './utils.class';
import { Area } from './area.class';
/* Buttons and actions */
export class Buttons {
    constructor(app) {
        this.app = app;
        this.all = Utils.id('nav').getElementsByTagName('li');
        this.rectangle = Utils.id('rectangle');
        this.circle = Utils.id('circle');
        this.polygon = Utils.id('polygon');
        this.edit = Utils.id('edit');
        this.clear = Utils.id('clear');
        this.to_html = Utils.id('to_html');
        this.show_help = Utils.id('show_help');
        this.rectangle.addEventListener('click', this.onShapeButtonClick.bind(this), false);
        this.circle.addEventListener('click', this.onShapeButtonClick.bind(this), false);
        this.polygon.addEventListener('click', this.onShapeButtonClick.bind(this), false);
        this.clear.addEventListener('click', this.onClearButtonClick.bind(this), false);
        this.to_html.addEventListener('click', this.onToHtmlButtonClick.bind(this), false);
        this.edit.addEventListener('click', this.onEditButtonClick.bind(this), false);
        this.show_help.addEventListener('click', this.onShowHelpButtonClick.bind(this), false);
    }
    deselectAll() {
        Utils.foreach(this.all, function (x) {
            x.classList.remove(Area.CLASS_NAMES.SELECTED);
        });
    }
    selectOne(button) {
        this.deselectAll();
        button.classList.add(Area.CLASS_NAMES.SELECTED);
    }
    onShapeButtonClick(e) {
        e.preventDefault();
        var target = e.target.id ? e.target : e.target.parentNode;
        // console.log('onShapeButtonClick', e, this, target, target.id);
        this.onSetInvalid();
        this.app.setMode('drawing')
            .setDrawClass()
            .setShape(target.id)
            .deselectAll()
            .hidePreview();
        // this.app.info.unload();
        this.selectOne(target);
    }
    onClearButtonClick(e) {
        e.preventDefault();
        // console.log('onClearButtonClick', e, this);
        // Clear all
        if (confirm('Clear all?')) {
            this.onSetInvalid();
            this.app.setMode(null)
                .setDefaultClass()
                .setShape(null)
                .clear()
                .hidePreview();
            this.deselectAll();
        }
    }
    onToHtmlButtonClick(e) {
        var answers = this.app.getAreas();
        var scale = 1;
        if (this.app.state.image.width > this.app.domElements.img.clientWidth) {
            scale = Number((this.app.state.image.width / this.app.domElements.img.clientWidth).toFixed(3));
        }
        else {
            scale = 1;
        }
        var resultsAnswers = [];
        answers.forEach(function (item, i, arr) {
            var imgMapData = item.toJSON();
            imgMapData.coords.forEach(function (item, i, arr) {
                imgMapData.coords[i] = Math.round(item * scale);
            });
            resultsAnswers.push({
                body: item.attributes.title,
                is_right: (item.attributes.alt == '1') ? true : false,
                img_map: JSON.stringify(imgMapData)
            });
        });
        this.onData(resultsAnswers, this.app.getAreasJSON(scale));
        // Generate html code only
        e.preventDefault();
    }
    onEditButtonClick(e) {
        e.preventDefault();
        this.onSetInvalid();
        if (this.app.getMode() === 'editing') {
            this.app.setMode(null)
                .setDefaultClass()
                .deselectAll();
            this.deselectAll();
            Utils.show(this.app.domElements.svg);
        }
        else {
            this.app.setShape(null)
                .setMode('editing')
                .setEditClass();
            this.selectOne(this.edit);
        }
        this.app.hidePreview();
    }
    onData(answers, areas) {
    }
    onSetInvalid() {
    }
    onShowHelpButtonClick(e) {
        this.app.help.show();
        e.preventDefault();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnV0dG9ucy5jbGFzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9idXR0b25zLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxLQUFLLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDcEMsT0FBTyxFQUFDLElBQUksRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUdsQyx5QkFBeUI7QUFDekIsTUFBTSxPQUFPLE9BQU87SUFXaEIsWUFBb0IsR0FBYztRQUFkLFFBQUcsR0FBSCxHQUFHLENBQVc7UUFWM0IsUUFBRyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakQsY0FBUyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDbEMsV0FBTSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUIsWUFBTyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDOUIsU0FBSSxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEIsVUFBSyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUIsWUFBTyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDOUIsY0FBUyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7UUFJckMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNwRixJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFD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MEJBQTBCO1FBQzFCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN2QixDQUFDO0lBR00saUJBQWlCLENBQUMsQ0FBQztRQUN0QixDQUFDLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFbkIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRXBCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxTQUFTLEVBQUU7WUFDbEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO2lCQUNqQixlQUFlLEVBQUU7aUJBQ2pCLFdBQVcsRUFBRSxDQUFDO1lBQ25CLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuQixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3hDO2FBQU07WUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7aUJBQ2xCLE9BQU8sQ0FBQyxTQUFTLENBQUM7aUJBQ2xCLFlBQVksRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzdCO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRU0sTUFBTSxDQUFDLE9BQWMsRUFBRSxLQUFVO0lBRXhDLENBQUM7SUFFTSxZQUFZO0lBRW5CLENBQUM7SUFFTSxxQkFBcUIsQ0FBQyxDQUFDO1FBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN2QixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1V0aWxzfSBmcm9tICcuL3V0aWxzLmNsYXNzJztcbmltcG9ydCB7QXJlYX0gZnJvbSAnLi9hcmVhLmNsYXNzJztcbmltcG9ydCB7RWRpdG9yQXBwfSBmcm9tICcuL2VkaXRvci1hcHAuY2xhc3MnO1xuXG4vKiBCdXR0b25zIGFuZCBhY3Rpb25zICovXG5leHBvcnQgY2xhc3MgQnV0dG9ucyB7XG4gICAgcHVibGljIGFsbCA9IFV0aWxzLmlkKCduYXYnKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbGknKTtcbiAgICBwdWJsaWMgcmVjdGFuZ2xlID0gVXRpbHMuaWQoJ3JlY3RhbmdsZScpO1xuICAgIHB1YmxpYyBjaXJjbGUgPSBVdGlscy5pZCgnY2lyY2xlJyk7XG4gICAgcHVibGljIHBvbHlnb24gPSBVdGlscy5pZCgncG9seWdvbicpO1xuICAgIHB1YmxpYyBlZGl0ID0gVXRpbHMuaWQoJ2VkaXQnKTtcbiAgICBwdWJsaWMgY2xlYXIgPSBVdGlscy5pZCgnY2xlYXInKTtcbiAgICBwdWJsaWMgdG9faHRtbCA9IFV0aWxzLmlkKCd0b19odG1sJyk7XG4gICAgcHVibGljIHNob3dfaGVscCA9IFV0aWxzLmlkKCdzaG93X2hlbHAnKTtcblxuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHA6IEVkaXRvckFwcCkge1xuICAgICAgICB0aGlzLnJlY3RhbmdsZS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25TaGFwZUJ1dHRvbkNsaWNrLmJpbmQodGhpcyksIGZhbHNlKTtcbiAgICAgICAgdGhpcy5jaXJjbGUuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uU2hhcGVCdXR0b25DbGljay5iaW5kKHRoaXMpLCBmYWxzZSk7XG4gICAgICAgIHRoaXMucG9seWdvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25TaGFwZUJ1dHRvbkNsaWNrLmJpbmQodGhpcyksIGZhbHNlKTtcbiAgICAgICAgdGhpcy5jbGVhci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25DbGVhckJ1dHRvbkNsaWNrLmJpbmQodGhpcyksIGZhbHNlKTtcbiAgICAgICAgdGhpcy50b19odG1sLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vblRvSHRtbEJ1dHRvbkNsaWNrLmJpbmQodGhpcyksIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vbkVkaXRCdXR0b25DbGljay5iaW5kKHRoaXMpLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuc2hvd19oZWxwLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vblNob3dIZWxwQnV0dG9uQ2xpY2suYmluZCh0aGlzKSwgZmFsc2UpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZXNlbGVjdEFsbCgpIHtcbiAgICAgICAgVXRpbHMuZm9yZWFjaCh0aGlzLmFsbCwgZnVuY3Rpb24gKHgpIHtcbiAgICAgICAgICAgIHguY2xhc3NMaXN0LnJlbW92ZShBcmVhLkNMQVNTX05BTUVTLlNFTEVDVEVEKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIHNlbGVjdE9uZShidXR0b246IGFueSkge1xuICAgICAgICB0aGlzLmRlc2VsZWN0QWxsKCk7XG4gICAgICAgIGJ1dHRvbi5jbGFzc0xpc3QuYWRkKEFyZWEuQ0xBU1NfTkFNRVMuU0VMRUNURUQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblNoYXBlQnV0dG9uQ2xpY2soZSkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldC5pZCA/IGUudGFyZ2V0IDogZS50YXJnZXQucGFyZW50Tm9kZTtcblxuICAgICAgICAvLyBjb25zb2xlLmxvZygnb25TaGFwZUJ1dHRvbkNsaWNrJywgZSwgdGhpcywgdGFyZ2V0LCB0YXJnZXQuaWQpO1xuXG4gICAgICAgIHRoaXMub25TZXRJbnZhbGlkKCk7XG5cbiAgICAgICAgdGhpcy5hcHAuc2V0TW9kZSgnZHJhd2luZycpXG4gICAgICAgICAgICAuc2V0RHJhd0NsYXNzKClcbiAgICAgICAgICAgIC5zZXRTaGFwZSh0YXJnZXQuaWQpXG4gICAgICAgICAgICAuZGVzZWxlY3RBbGwoKVxuICAgICAgICAgICAgLmhpZGVQcmV2aWV3KCk7XG4gICAgICAgIC8vIHRoaXMuYXBwLmluZm8udW5sb2FkKCk7XG4gICAgICAgIHRoaXMuc2VsZWN0T25lKHRhcmdldCk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uQ2xlYXJCdXR0b25DbGljayhlKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ29uQ2xlYXJCdXR0b25DbGljaycsIGUsIHRoaXMpO1xuXG4gICAgICAgIC8vIENsZWFyIGFsbFxuICAgICAgICBpZiAoY29uZmlybSgnQ2xlYXIgYWxsPycpKSB7XG4gICAgICAgICAgICB0aGlzLm9uU2V0SW52YWxpZCgpO1xuXG4gICAgICAgICAgICB0aGlzLmFwcC5zZXRNb2RlKG51bGwpXG4gICAgICAgICAgICAgICAgLnNldERlZmF1bHRDbGFzcygpXG4gICAgICAgICAgICAgICAgLnNldFNoYXBlKG51bGwpXG4gICAgICAgICAgICAgICAgLmNsZWFyKClcbiAgICAgICAgICAgICAgICAuaGlkZVByZXZpZXcoKTtcbiAgICAgICAgICAgIHRoaXMuZGVzZWxlY3RBbGwoKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcHVibGljIG9uVG9IdG1sQnV0dG9uQ2xpY2soZSkge1xuICAgICAgICB2YXIgYW5zd2VycyA9IHRoaXMuYXBwLmdldEFyZWFzKCk7XG4gICAgICAgIHZhciBzY2FsZSA9IDE7XG4gICAgICAgIGlmICh0aGlzLmFwcC5zdGF0ZS5pbWFnZS53aWR0aCA+IHRoaXMuYXBwLmRvbUVsZW1lbnRzLmltZy5jbGllbnRXaWR0aCkge1xuICAgICAgICAgICAgc2NhbGUgPSBOdW1iZXIoKHRoaXMuYXBwLnN0YXRlLmltYWdlLndpZHRoIC8gdGhpcy5hcHAuZG9tRWxlbWVudHMuaW1nLmNsaWVudFdpZHRoKS50b0ZpeGVkKDMpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHNjYWxlID0gMTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmVzdWx0c0Fuc3dlcnM6IGFueVtdID0gW107XG4gICAgICAgIGFuc3dlcnMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSwgaSwgYXJyKSB7XG4gICAgICAgICAgICB2YXIgaW1nTWFwRGF0YSA9IGl0ZW0udG9KU09OKCk7XG4gICAgICAgICAgICBpbWdNYXBEYXRhLmNvb3Jkcy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtLCBpLCBhcnIpIHtcbiAgICAgICAgICAgICAgICBpbWdNYXBEYXRhLmNvb3Jkc1tpXSA9IE1hdGgucm91bmQoaXRlbSAqIHNjYWxlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVzdWx0c0Fuc3dlcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgYm9keTogaXRlbS5hdHRyaWJ1dGVzLnRpdGxlLFxuICAgICAgICAgICAgICAgIGlzX3JpZ2h0OiAoaXRlbS5hdHRyaWJ1dGVzLmFsdCA9PSAnMScpID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGltZ19tYXA6IEpTT04uc3RyaW5naWZ5KGltZ01hcERhdGEpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5vbkRhdGEocmVzdWx0c0Fuc3dlcnMsIHRoaXMuYXBwLmdldEFyZWFzSlNPTihzY2FsZSkpO1xuXG4gICAgICAgIC8vIEdlbmVyYXRlIGh0bWwgY29kZSBvbmx5XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBvbkVkaXRCdXR0b25DbGljayhlKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICB0aGlzLm9uU2V0SW52YWxpZCgpO1xuXG4gICAgICAgIGlmICh0aGlzLmFwcC5nZXRNb2RlKCkgPT09ICdlZGl0aW5nJykge1xuICAgICAgICAgICAgdGhpcy5hcHAuc2V0TW9kZShudWxsKVxuICAgICAgICAgICAgICAgIC5zZXREZWZhdWx0Q2xhc3MoKVxuICAgICAgICAgICAgICAgIC5kZXNlbGVjdEFsbCgpO1xuICAgICAgICAgICAgdGhpcy5kZXNlbGVjdEFsbCgpO1xuICAgICAgICAgICAgVXRpbHMuc2hvdyh0aGlzLmFwcC5kb21FbGVtZW50cy5zdmcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hcHAuc2V0U2hhcGUobnVsbClcbiAgICAgICAgICAgICAgICAuc2V0TW9kZSgnZWRpdGluZycpXG4gICAgICAgICAgICAgICAgLnNldEVkaXRDbGFzcygpO1xuICAgICAgICAgICAgdGhpcy5zZWxlY3RPbmUodGhpcy5lZGl0KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFwcC5oaWRlUHJldmlldygpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbkRhdGEoYW5zd2VyczogYW55W10sIGFyZWFzOiBhbnkpIHtcblxuICAgIH1cblxuICAgIHB1YmxpYyBvblNldEludmFsaWQoKSB7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgb25TaG93SGVscEJ1dHRvbkNsaWNrKGUpIHtcbiAgICAgICAgdGhpcy5hcHAuaGVscC5zaG93KCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG59XG4iXX0=